import express, { response } from 'express';
import { PineconeClient } from "@pinecone-database/pinecone";
import { Configuration, OpenAIApi } from "openai";
import { customAlphabet } from 'nanoid'
const nanoid = customAlphabet('1234567890abcdefghijklmnopqrstuvwxyz', 10)
import axios from 'axios'
const configuration = new Configuration({
    apiKey: process.env.OPENAI_API_KEY,
});
const openai = new OpenAIApi(configuration);

const pinecone = new PineconeClient();
await pinecone.init({
    environment: process.env.PINECONE_ENVIRONMENT,
    apiKey: process.env.PINECONE_API_KEY,
});

let router = express.Router()

router.post('/faq', async (req, res, next) => {

    if (
        !req.body.question
        || !req.body.answer
    ) {
        res.status(403);
        res.send(`required parameters missing, 
        example request body:
        {
            question: "can I use this dashboard without permission of inzamam malik",
            answer: "no you can not"
           
        } `);
        return;
    }

    const response = await openai.createEmbedding({
        model: "text-embedding-ada-002",
        input: `${req.body.question} - ${req.body.answer}`,
    });
    const vector = response?.data?.data[0]?.embedding
    console.log("vector: ", vector);

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);
    const upsertRequest = {
        vectors: [
            {
                id: nanoid(), // unique id,
                values: vector,
                metadata: {
                    question: req.body.question,
                    answer: req.body.answer,
                    created: Date.now(),
                    modified: Date.now()
                },
            }
        ],
        namespace: process.env.PINECONE_NAME_SPACE,
    };
    const upsertResponse = await index.upsert({ upsertRequest });

    res.send('post created');
})
router.post('/faqs', async (req, res, next) => {


    req.body.map(eachQuestion => {
        if (
            !eachQuestion.question
            || !eachQuestion.answer
        ) {
            res.status(403);
            res.send(`required parameters missing, 
            example request body:
            [{
                question: "can I use this dashboard without permission of inzamam malik",
                answer: "no you can not"
            }] `);
            return;
        }
    })

    const allQuestionEmbeddingRequests = questions.map((eachQuestion, index) => {
        return openai.createEmbedding({
            model: "text-embedding-ada-002",
            input: `${eachQuestion.question} - ${eachQuestion.answer}`,
        });
    })
    console.log("converting all questions into vector with openai embedding... please wait");
    const allQuestionsVector = await Promise.all(allQuestionEmbeddingRequests)


    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);

    const upsertRequest = {
        vectors: [
            // {
            //     id: nanoid(), // unique id
            //     values: vector,
            //     metadata: {
            //         genre: "drama",
            //     },
            // }
        ],
        namespace: process.env.PINECONE_NAME_SPACE,
    };
    console.log("allQuestionsVector: ", allQuestionsVector);

    allQuestionsVector.map(eachVectorResponse => {

        const originalText = JSON.parse(eachVectorResponse.config.data).input
        const vectorRepresentation = eachVectorResponse?.data?.data[0]?.embedding

        console.log("originalText: ", originalText);
        // console.log("vectorRepresentation: ", vectorRepresentation);

        upsertRequest.vectors.push({
            id: nanoid(), // unique id
            values: vectorRepresentation,
            metadata: {
                // TODO: fix this
                question: req.body.question,
                answer: req.body.answer,
                created: Date.now(),
                modified: Date.now()
            },
        },)

    })
    const upsertRequest = {
        vectors: [
            {
                id: nanoid(), // unique id,
                values: vector,
                metadata: {
                    question: req.body.question,
                    answer: req.body.answer,
                    created: Date.now(),
                    modified: Date.now()
                },
            }
        ],
        namespace: process.env.PINECONE_NAME_SPACE,
    };
    const upsertResponse = await index.upsert({ upsertRequest });

    res.send('post created');
})
router.get('/faqs', async (req, res, next) => {

    const emptyStringVector = [0.0015720829, -0.01673626, -0.0009687884, 0.002483524, 0.0024590557, 0.013702201, -0.0011500061, 0.00048554115, 0.020271916, -0.0012838166, 0.0052086716, -0.0012746411, -0.0030432343, -0.007707488, 0.000063560015, -0.0123870345, 0.014876675, -0.012179054, 0.0049150526, -0.018326694, 0.013530923, -0.005902957, -0.011383837, -0.0027679668, -0.013212836, 0.0010704844, 0.027306529, -0.039662976, 0.02645014, -0.037607647, -0.0047804774, 0.0074689225, -0.016283598, 0.004306406, -0.005318778, -0.0080255745, 0.0007455159, 0.0037803394, 0.010087022, 0.008894197, 0.004499093, -0.022327246, 0.003278741, 0.008062277, -0.011928255, 0.006667589, 0.0056215725, -0.029288454, -0.016038915, 0.006019181, 0.03770552, 0.005612397, -0.019855957, -0.006777696, 0.04553535, -0.007156953, 0.013176134, 0.009762818, -0.010490747, -0.0071018995, -0.015206995, -0.017323496, -0.070272714, 0.028089512, 0.01116974, -0.0022770732, 0.013066027, 0.0044318056, 0.013592093, 0.0021088542, 0.017763924, 0.002769496, 0.006117054, 0.010674259, -0.010747664, -0.005554285, 0.009444731, -0.02302459, -0.02454162, -0.00255387, 0.016785195, -0.000547094, 0.0024651727, 0.008961484, 0.0130537925, 0.007884882, -0.018632546, 0.011383837, 0.0019482817, -0.018204352, -0.0109862285, -0.010337821, 0.007890999, -0.004254411, -0.011867085, 0.04568216, -0.0014260382, 0.014937845, -0.0033460285, -0.014154863, -0.0012746411, -0.00009137349, -0.026939506, 0.035601255, -0.02796717, -0.017299028, 0.013445284, 0.0026333916, -0.0025095213, -0.03127038, -0.016834132, -0.012968154, -0.008496588, -0.026939506, 0.006594184, 0.008924781, 0.02659695, 0.001291463, -0.0109862285, 0.020443194, -0.0030310003, -0.0037130518, 0.008753504, -0.003755871, 0.007358816, -0.011677456, -0.018057544, -0.01069261, -0.00957319, -0.017029878, 0.029043771, 0.007046846, -0.020797983, -0.028970366, 0.007389401, 0.031417187, -0.009989149, 0.019317657, 0.013274007, -0.0039669094, 0.014974548, 0.034328908, -0.0030600561, -0.014937845, 0.028529938, -0.010013618, 0.023134697, -0.027502274, -0.010662025, -0.025398007, 0.012760174, 0.004997633, 0.0053615975, -0.029410794, 0.0027419694, 0.0055512264, -0.009512018, -0.0012364095, -0.027869297, -0.019244252, 0.029508667, 0.0011064222, -0.007254826, 0.012435971, -0.001590434, 0.018571375, 0.0112798475, 0.031148039, 0.010582503, -0.027893765, -0.02406449, 0.03344805, -0.011548998, 0.010472396, -0.010949526, 0.023575125, 0.0002976329, 0.018363396, -0.02007617, -0.017690519, -0.021544263, -0.0020430959, -0.0008089804, 0.021042665, 0.0015797291, 0.024908643, 0.030927824, -0.0017127751, 0.03550338, 0.016430406, 0.008031691, 0.030120373, 0.030511865, 0.0010811893, -0.69333136, -0.020687876, 0.008264139, -0.021923522, 0.000040095376, 0.026768228, -0.0019803962, 0.02493311, -0.0069612074, 0.02489641, -0.0010184895, 0.016760727, 0.003232863, 0.0037069346, 0.0007566031, -0.02275544, -0.012289161, -0.037460838, 0.0041932403, 0.0009152642, -0.0071080164, 0.013530923, -0.015427209, -0.013469753, -0.015109123, -0.01584317, 0.005649099, 0.01828999, -0.0039454997, 0.0046275514, 0.02439481, 0.013445284, 0.027600147, 0.03976085, -0.0018855819, -0.003024883, -0.0036365886, 0.019256486, 0.0075423275, 0.01658945, -0.03878212, -0.01879159, 0.0041595967, -0.023929914, -0.0069612074, -0.0026257453, 0.023966616, -0.010350055, 0.0032236874, -0.014008054, -0.008129564, 0.0017800627, -0.016026681, 0.005092447, -0.0012731118, 0.023611829, 0.008845259, 0.013371879, 0.013579859, 0.018216586, -0.010209363, -0.009157229, 0.0065085455, 0.013298475, 0.037778925, 0.026645886, 0.0023382439, -0.008747387, 0.005838728, -0.00041748892, -0.021250645, 0.011414423, 0.0042115916, 0.008777972, 0.014362843, -0.009811754, 0.021152772, -0.0018045309, -0.0022204905, -0.020932559, 0.0045541464, -0.0049364623, -0.008306959, -0.01168969, 0.026670355, -0.0000631777, 0.0071324846, 0.020333087, 0.039785318, -0.010068671, 0.018975101, 0.032151233, -0.00037619882, -0.009628243, -0.010766014, 0.0032236874, -0.009536487, -0.0063127996, 0.0044776835, -0.0037405784, 0.031172507, -0.017922968, 0.0086189285, 0.009940213, 0.03643317, 0.00492117, 0.007260943, 0.016516045, 0.01903627, -0.043528955, -0.0040556067, -0.036971472, -0.027477806, -0.005031277, 0.0019345182, -0.016919771, 0.012154586, 0.0003639647, 0.020333087, -0.016442642, 0.028603343, 0.008869728, 0.011701924, -0.015292634, 0.016870834, 0.008747387, 0.0048844675, -0.003691642, -0.0006885509, -0.00234589, 0.004538854, -0.018938398, 0.0038323342, -0.014301672, -0.020651173, 0.007156953, 0.0046275514, -0.013873478, 0.014913377, -0.027918234, 0.018473502, -0.021825649, -0.0066370033, 0.026792696, -0.021629902, -0.02742887, 0.008374247, 0.00023684467, 0.027012909, -0.005006809, 0.012307513, -0.006135405, -0.0099463295, 0.011261496, -0.0026578598, -0.010166544, 0.013543157, 0.008337544, -0.016797429, -0.015439444, -0.0057439134, 0.023697466, -0.043920446, -0.009762818, -0.01953787, -0.012601131, 0.025398007, 0.006716525, 0.00035230408, -0.031074634, -0.010802717, -0.0038690364, -0.004208533, 0.008355896, -0.00784818, 0.016246894, -0.008631163, -0.011805914, -0.013959117, -0.025936307, -0.0070835482, -0.014020287, -0.012344215, -0.0096527105, 0.016821899, 0.007004027, 0.006814398, 0.0066614714, -0.00481718, 0.012931452, -0.005939659, -0.0030508805, 0.0047682435, 0.019904893, -0.011738626, -0.0053554806, 0.02200916, 0.0028627813, -0.0015720829, 0.026792696, 0.009096059, 0.006832749, 0.022351714, -0.007401635, 0.0038873877, -0.03293422, -0.009542604, 0.0028933664, -0.010178777, 0.01638147, 0.013151666, -0.0013732786, 0.0076402, -0.0070835482, 0.010558035, -0.0065513644, 0.000057729696, 0.0052729, -0.017103283, -0.033521455, 0.0055114655, 0.013249539, -0.0018137065, 0.0147543335, -0.013237304, 0.039711915, -0.0002831049, -0.006251629, 0.01673626, -0.001416098, -0.0305608, 0.009872925, -0.007921585, 0.017861797, -0.005413593, 0.0020981494, -0.0030952292, -0.034989547, 0.042745974, 0.006722642, -0.012246341, 0.02439481, 0.0052667833, -0.009983032, -0.0065697157, 0.0047284826, 0.030952292, 0.0015934926, 0.0129803885, -0.003575418, -0.0136410305, -0.016369237, -0.037167218, 0.0044470984, -0.00083803636, -0.01712775, 0.019843722, -0.003180868, 0.015818702, 0.015928809, -0.005786733, 0.019672446, 0.011848733, 0.011524529, 0.01137772, -0.016907537, 0.011604051, 0.002914776, 0.01069261, 0.00853329, -0.030903356, -0.012148469, -0.0074628056, -0.013176134, 0.011243145, 0.0128335785, -0.0005405946, 0.009432497, 0.0060589416, -0.010325586, -0.005101623, -0.0068449834, 0.034182098, 0.02082245, 0.0023535364, 0.006704291, -0.0025798674, -0.021140538, -0.0072915284, 0.025446944, -0.0134208165, 0.010178777, -0.014313906, 0.0025049336, -0.008092863, -0.010729313, 0.017690519, -0.013151666, 0.016405938, -0.004324757, 0.017409135, -0.03127038, -0.016357003, 0.0061568148, 0.0033185016, 0.011298198, -0.0024514094, -0.02823632, -0.004621434, -0.013188368, 0.00463061, -0.037167218, 0.009297922, 0.008900314, -0.023954382, 0.009885159, -0.013689967, 0.014925611, 0.028578876, 0.007921585, -0.009267337, -0.00073328183, -0.02933739, -0.02120171, 0.07115357, 0.043528955, 0.0033674382, -0.01168969, 0.006588067, -0.005077155, -0.002229666, 0.02132405, -0.018559141, -0.0034989547, -0.019855957, -0.0005134502, -0.0010376052, 0.00874127, 0.0066431207, 0.0294842, -0.008521056, -0.021311816, 0.0031961605, -0.0065085455, -0.008184618, -0.0077931266, 0.015745297, 0.0008839143, 0.041498095, 0.004358401, 0.015806466, 0.03829276, -0.009952446, 0.0032573312, 0.013861244, 0.0029208933, -0.0017173629, 0.009359092, -0.009689413, -0.00043239925, 0.009187815, 0.01891393, 0.020382022, 0.008392598, -0.0021226178, -0.009230634, 0.005829552, -0.039247017, 0.007988872, -0.027330996, -0.0033521454, 0.038097013, -0.017029878, -0.011879318, 0.022241607, 0.00021027372, -0.023354912, -0.03878212, 0.019342124, 0.009456965, 0.012564428, -0.004557205, -0.019635743, -0.008478236, 0.0029621832, -0.011163623, -0.025422476, -0.01189767, 0.0028627813, 0.0022189613, 0.008050043, -0.010282768, -0.012870281, -0.0041106604, -0.015231464, -0.016601684, -0.0007428397, -0.006814398, -0.012124001, 0.032028895, 0.00942638, -0.009120528, 0.0034530768, 0.0067654615, -0.003807866, -0.045437478, 0.007260943, -0.035062954, -0.0072976453, -0.0039393827, 0.00996468, 0.009628243, -0.021213943, -0.0021287347, 0.027722487, 0.018008607, -0.00421465, 0.006236336, -0.0037528125, 0.010258299, -0.0001649693, 0.006260805, -0.014729866, 0.002628804, 0.008294725, -0.018314458, -0.038708717, -0.007224241, 0.0047376584, -0.009567073, 0.0085394075, 0.014668695, -0.010466279, 0.00836813, 0.007364933, 0.002257193, 0.0065085455, 0.0050404523, -0.007493391, 0.015769765, 0.016626153, 0.008673983, -0.016785195, -0.0014367431, -0.012111766, -0.00028329605, 0.015512848, 0.00037409607, 0.008888079, 0.013592093, 0.007175304, -0.03591934, -0.008050043, 0.01252161, 0.0027480864, 0.023049058, -0.008833026, -0.004648961, -0.0027251474, 0.02111607, -0.00942638, -0.0015155001, -0.0072364747, -0.02117724, -0.023513954, -0.00011440802, -0.007976638, 0.012968154, -0.016980942, -0.04360236, -0.021519795, -0.015414976, 0.0023000122, 0.0053615975, -0.02034532, 0.0025232846, -0.003431667, -0.0016011389, 0.016699556, 0.003361321, -0.03249379, 0.0060467077, 0.027086314, 0.024321405, 0.0020308618, 0.00014040551, 0.013836776, 0.005572636, -0.012772408, -0.008527173, 0.028970366, -0.002136381, -0.023893213, 0.023599593, 0.014277204, -0.012007777, -0.0010513687, -0.022437353, -0.000291707, 0.0012065888, 0.005618514, 0.0053004273, -0.023844276, -0.007419986, -0.008410949, -0.00064726075, 0.013946882, 0.011591817, -0.01885276, -0.0173602, -0.008998186, 0.029215049, 0.023220336, 0.011879318, 0.008551641, -0.035845935, 0.020871388, 0.0036885834, 0.022155968, -0.0073282304, -0.019280953, 0.005171969, -0.011909904, 0.018069778, 0.008967601, 0.0055512264, 0.011059633, 0.009860691, 0.015084655, 0.010074788, -0.0005860902, -0.0025339895, 0.021556498, -0.02975335, 0.007040729, -0.013971351, 0.0042574694, -0.0015009721, 0.0026899744, -0.012503258, -0.0129803885, 0.022718739, -0.00085485826, -0.02933739, -0.004957872, 0.0146809295, -0.011879318, -0.007909351, 0.026352268, 0.033227835, 0.0019222841, 0.009267337, 0.037607647, -0.0009833165, -0.007646317, 0.027746957, -0.019758085, -0.004655078, 0.012362566, -0.014876675, 0.024578322, -0.033937413, -0.04604918, 0.028627813, 0.0163203, -0.015390508, -0.002373417, -0.02296342, -0.010998463, -0.014044756, -0.01879159, 0.00047636556, 0.0007034612, -0.010209363, -0.022327246, 0.021067133, -0.007707488, 0.0305608, -0.0022770732, -0.019072974, 0.014154863, -0.008472119, -0.0103928745, -0.013408582, -0.025446944, 0.017996373, -0.009028772, 0.010992345, -0.010710961, 0.016479343, -0.005578753, -0.020235214, 0.010472396, 0.014668695, -0.01233198, -0.0076402, -0.018608078, 0.0072058896, 0.0039852606, 0.010998463, -0.0050496277, -0.02269427, -0.000026523163, -0.0055634603, 0.0032420384, 0.015928809, 0.02645014, 0.0073343473, -0.020504365, 0.013078261, -0.018620312, -0.0052729, 0.012662302, -0.013604328, -0.0037283443, -0.0006958149, -0.0064534917, -0.002333656, -0.030903356, 0.0100197345, 0.0064901942, 0.023868743, 0.003575418, 0.014044756, 0.016161256, -0.005327954, -0.005113857, -0.011341018, -0.0017693578, -0.036090616, 0.007646317, -0.006838866, -0.038953397, -0.0110535165, 0.005863196, 0.00894925, -0.004349225, -0.007401635, 0.041204475, 0.018424567, -0.014485183, -0.011396071, -0.01906074, 0.032567196, 0.0048385896, 0.013616562, -0.017384667, -0.028138448, 0.0056919185, -0.006175166, -0.0054533533, -0.0029851224, 0.00587543, -0.035307635, -0.01650381, 0.022107033, -0.017666051, -0.009291804, -0.020810217, -0.0050985646, -0.015109123, -0.0076830196, -0.04768855, -0.0016301948, -0.017996373, 0.02468843, 0.027159719, -0.009976915, -0.007872649, 0.008417066, -0.002501875, -0.017042112, -0.019452231, -0.012699003, -0.051481124, 0.0033001506, -0.0093529755, 0.014888909, -0.028285258, 0.0045724977, -0.023477253, -0.0010077846, -0.013738903, 0.009420263, -0.008508822, -0.0004071664, -0.016540514, 0.017886266, -0.0031869852, 0.0068511004, -0.014558588, -0.0040556067, 0.0017922968, -0.013934649, -0.008771855, -0.0029178348, -0.009279571, -0.002433058, 0.0031533414, 0.023269273, 0.010551918, 0.018082011, -0.016014447, 0.03286081, -0.0046000243, -0.00040601945, 0.0107966, 0.010203246, -0.014815505, 0.009212283, -0.008050043, 0.009921861, -0.003963851, 0.007725839, -0.0057897912, 0.0100197345, 0.0054197097, -0.0030202954, -0.00039569693, 0.002738911, 0.0015736121, -0.015414976, 0.0057836743, 0.0040861918, -0.00049204053, 0.022706503, -0.017237857, 0.0023305975, -0.034475714, -0.029998032, -0.0043920446, 0.0032756822, 0.0015399683, 0.00042131208, 0.016259128, 0.020186277, 0.009157229, -0.027918234, 0.02147086, 0.016944239, -0.010594737, -0.028750153, -0.0015025013, -0.016454875, -0.0012868752, 0.012246341, -0.0056032212, 0.02117724, 0.024015553, -0.025128856, 0.0134208165, -0.0051199743, 0.012013894, 0.00012712003, 0.007854297, -0.017568178, 0.008349778, 0.0017968846, 0.019354358, -0.012735706, 0.23176293, -0.012735706, -0.022816611, 0.01289475, -0.03127038, 0.013971351, 0.030536333, 0.012497141, 0.008563875, 0.0052912515, -0.009707765, -0.019513402, -0.003575418, -0.03454912, 0.009518135, -0.00863728, -0.01179368, -0.029679945, -0.01106575, -0.018962868, -0.015794232, 0.01175086, 0.0067409934, -0.00500375, 0.010490747, 0.018057544, -0.009102176, 0.02117724, 0.008300842, -0.004138187, -0.010331704, 0.012099532, 0.0014053931, -0.027184187, -0.015317103, 0.0021623785, -0.0025966894, 0.021226177, 0.026915036, 0.025691627, -0.022302778, 0.023905447, -0.033912946, -0.0012692887, 0.03961404, -0.010142075, -0.026670355, -0.007695254, 0.0049486966, -0.024774069, -0.029190581, 0.026523545, 0.0051169153, 0.015622956, 0.0342555, -0.0020583887, 0.018938398, 0.0032665068, -0.02007617, 0.008937015, -0.016638387, 0.004905877, -0.019843722, 0.020406492, -0.0055420506, 0.019892659, 0.004670371, 0.0046244925, 0.012784642, -0.027404401, -0.0011675927, -0.017470306, 0.021666605, 0.007994989, -0.047199186, -0.012870281, 0.017421369, -0.00036320006, 0.02117724, 0.031466126, 0.011634637, 0.0063189166, -0.010918941, -0.0036457642, -0.0025630456, -0.030634206, -0.0029637127, -0.0032634481, 0.02439481, -0.014986782, -0.00090532395, -0.017971905, 0.01754371, 0.010343938, 0.005263725, -0.0032083946, -0.012099532, 0.023758637, -0.02358736, -0.0022082564, -0.008337544, 0.012350332, -0.007946053, 0.027477806, -0.012625599, -0.013066027, -0.00041328344, -0.014864441, 0.009567073, -0.009334624, 0.025177794, -0.0041871234, 0.0049884575, 0.012007777, -0.009732232, 0.027746957, 0.020467661, -0.00019278277, -0.009879042, 0.0023000122, -0.003349087, -0.026743758, -0.0002649449, 0.0113532515, 0.0011660634, -0.03523423, -0.02507992, 0.017433604, 0.009022654, -0.030120373, 0.022425119, 0.0075729126, 0.008924781, -0.00036836133, 0.002722089, -0.0015086184, 0.034059756, -0.01899957, -0.002942303, 0.011971074, -0.0036488227, -0.010772131, 0.010386758, 0.0068572173, 0.010197129, -0.017152218, 0.009310156, -0.021837883, -0.022498524, -0.008001107, -0.018485736, 0.017164454, -0.0024422337, 0.0017158336, 0.0024865824, -0.021409689, -0.027869297, -0.013286241, -0.003865978, 0.013800073, -0.0064167893, -0.018179884, 0.024823004, -0.02236395, 0.018546907, -0.009921861, -0.15385614, 0.023220336, 0.0039087976, 0.012099532, -0.0013801602, -0.0123136295, 0.011854851, -0.015684126, 0.0005004515, -0.004957872, 0.005704153, 0.007756424, -0.01899957, -0.007860414, -0.007750307, 0.008270257, -0.015390508, 0.004746834, 0.014179331, -0.008563875, 0.00021734658, -0.0011652987, 0.0056613334, 0.0026532721, -0.0031839265, 0.0013954529, -0.0145341195, 0.020174043, -0.024871942, 0.011536764, -0.01941553, -0.0103928745, 0.03293422, -0.0019436938, 0.0024116484, 0.011328784, 0.004239118, -0.0016332534, -0.03308103, 0.020675642, 0.022584163, 0.016993176, 0.020100638, 0.006783813, -0.029924627, 0.022143735, -0.003976085, -0.01575753, 0.011328784, -0.044165127, -0.016711792, -0.009793404, 0.002275544, 0.013604328, 0.01849797, 0.028358663, 0.0047284826, 0.014766568, 0.0011844146, 0.0004652784, -0.009151112, -0.016173491, 0.0060436493, 0.0045541464, 0.009334624, 0.008355896, -0.012809111, 0.039711915, -0.015879871, 0.006594184, 0.0040066703, 0.007273177, -0.0051811445, -0.035454445, 0.0029621832, 0.017531477, -0.0020981494, 0.014008054, 0.010888356, 0.0076830196, -0.030952292, 0.03361933, 0.006502428, 0.018363396, 0.015977744, 0.028603343, -0.02090809, -0.006936739, -0.026963973, -0.022155968, 0.008661748, -0.013812307, 0.001706658, -0.017470306, -0.0058020256, 0.025765032, 0.013922415, 0.022682035, -0.0042819376, -0.012117883, 0.008074511, -0.011010697, -0.024590556, -0.015023484, 0.0173969, -0.0004775125, -0.011964957, 0.022351714, 0.013286241, -0.028750153, 0.004905877, 0.009144995, 0.016760727, -0.017139984, -0.00161949, 0.0071018995, 0.006924505, -0.0022220197, -0.017029878, 0.01712775, 0.04690557, -0.0019712206, 0.007946053, 0.01584317, -0.018008607, -0.006588067, -0.08828132, -0.008154033, 0.032102298, 0.008937015, -0.030927824, 0.039100207, 0.018338928, -0.005312661, 0.000547094, 0.009181698, -0.0050006914, 0.0004583967, 0.013090495, -0.008992069, 0.038415097, 0.016197959, 0.00062967424, -0.03702041, -0.009560955, 0.03139272, -0.0038048076, -0.0056276894, -0.025495881, -0.010221597, -0.027942702, -0.009554838, -0.02493311, 0.018877229, 0.0016883068, 0.008588344, -0.0011033636, -0.0019238135, 0.004138187, -0.025349071, -0.005321837, 0.021568732, -0.016993176, -0.011218676, 0.010582503, -0.008661748, -0.0029942978, -0.007487274, -0.008147916, -0.0268661, -0.0046397853, -0.0038048076, -0.025495881, 0.035625722, 0.02412566, -0.013971351, -0.02364853, 0.0068816855, 0.0074077523, -0.010668142, 0.03139272, -0.0078053605, 0.0064167893, -0.01085777, 0.0018167649, 0.0053432467, -0.011077984, 0.017886266, -0.016638387, 0.013151666, -0.02221714, 0.0066737058, -0.019085208, -0.007817595, 0.00070002035, -0.03645764, 0.012637833, -0.013604328, -0.012882516, 0.011922138, -0.026425673, 0.03014484, -0.012411502, -0.0113532515, 0.013004856, -0.011151389, -0.014044756, -0.0012509375, 0.018779356, 0.0168586, 0.009787286, 0.009683296, -0.022596397, 0.011983308, 0.0018840525, 0.017519243, -0.0046826047, -0.011879318, 0.016100086, -0.012601131, -0.008563875, -0.018082011, -0.01914638, -0.003878212, 0.029239517, 0.006380087, -0.008105096, -0.009047123, -0.06772802, 0.03457359, -0.012552194, 0.01168969, 0.0003303209, 0.008374247, 0.009787286, -0.02070011, -0.014693163, 0.022669801, -0.015145825, 0.019550104, -0.034769334, 0.021030432, -0.0326406, -0.014974548, 0.009230634, 0.010606972, -0.022743206, 0.006722642, 0.0016561924, 0.016210193, -0.0039210315, 0.020382022, 0.008569992, 0.022192672, 0.0005379184, 0.012435971, -0.022204906, -0.008875845, 0.0117202755, -0.028309725, 0.008184618, 0.018387863, -0.000896913, -0.009242868, -0.0011530647, 0.017225623, -0.0031563998, -0.010839419, -0.023783104, -0.037460838, 0.014717632, -0.014044756, -0.0052331397, 0.013665498, -0.0003112051, 0.014986782, 0.011879318, 0.0075790295, -0.004376752, -0.006973441, 0.0086189285, 0.00090455933, 0.005728621, 0.0040464313, 0.005985537, 0.008264139, 0.019941596, -0.013298475, -0.0032817994, 0.0044532153, 0.019770319, -0.014020287, 0.012068947, 0.011591817, -0.021042665, -0.027502274, 0.00469178, -0.026963973, -0.038488504, 0.0025599871, 0.00082503766, -0.0058998982, -0.031245911, 0.0029637127, 0.0038904462, 0.011842616, -0.017201155, 0.026817163, -0.0013587506, -0.011273731, -0.023746403, 0.029826755, 0.025985245, 0.03589487, 0.0027557327, 0.024260236, -0.0012677594, 0.0052698418, -0.037632115, -0.0058020256, 0.026034182, 0.016919771, 0.02769802, 0.00025844554, 0.0040494897, 0.019868191, 0.004786595, 0.032738473, -0.008392598, 0.0046581365, -0.012105649, -0.019941596, -0.008062277, -0.026768228, -0.01048463, -0.008563875, 0.0041565383, 0.028701216, 0.020296386, -0.000093619594, -0.03290975, 0.044923645, -0.0058234353, -0.014962314, 0.010282768, -0.028187385, -0.026743758, 0.00894925, -0.015525083, 0.018803824, -0.009609892, 0.0018779355, -0.0050343354, 0.015451678, -0.026132055, -0.023783104, -0.025275666, 0.012858047, -0.004557205, -0.030046968, -0.024651727, -0.012882516, 0.002670094, 0.004584732, 0.025936307, 0.0048202383, -0.006588067, 0.04086192, 0.0047376584, 0.0024498801, 0.017922968, -0.008423183, -0.0064290236, 0.012809111, 0.038879994, 0.013653264, -0.0046978975, -0.016418172, -0.017568178, 0.016577216, -0.010502981, -0.01058862, 0.021678839, -0.002425412, 0.011665221, -0.005850962, 0.018669248, 0.0032420384, 0.0048905844, -0.0065513644, -0.0102399485, -0.003407199, -0.018987335, 0.012503258, 0.02454162, -0.0045327367, -0.015488381, 0.023012357, -0.011157506, -0.040959794, -0.0036029448, 0.025593754, -0.011640754, 0.0051597347, 0.0052514905, 0.00086862163, 0.005921308, 0.002460585, -0.008209086, -0.0149011435, -0.032567196, 0.020479897, 0.017139984, -0.010411225, -0.021042665, -0.0048447065]

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);
    const queryResponse = await index.query({
        queryRequest: {
            vector: emptyStringVector,
            // id: "vec1",
            topK: 10000, // 10000 is maximum
            includeValues: true,
            includeMetadata: true,
            namespace: process.env.PINECONE_NAME_SPACE
        }
    });

    const response = [];

    queryResponse.matches.map(eachMatch => {
        // console.log(`score ${eachMatch.score.toFixed(1)} => ${JSON.stringify(eachMatch.metadata)}\n\n`);
        response.push({ id: eachMatch.id, ...eachMatch.metadata });
    })
    console.log(`${queryResponse.matches.length} records found `);


    res.send(response);
})
router.get('/faq/:faqId', async (req, res, next) => {

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);
    const queryResponse = await index.query({
        queryRequest: {
            id: req.params.faqId,
            topK: 1,
            includeValues: true,
            includeMetadata: true,
            namespace: process.env.PINECONE_NAME_SPACE
        }
    });

    const response = [];

    queryResponse.matches.map(eachMatch => {
        // console.log(`score ${eachMatch.score.toFixed(1)} => ${JSON.stringify(eachMatch.metadata)}\n\n`);
        response.push({ id: eachMatch.id, ...eachMatch.metadata });
    })
    console.log(`${queryResponse.matches.length} records found `);
    res.send(response[0]);
})


router.put('/faq/:faqId', async (req, res, next) => {
    if (
        !req.body.question
        || !req.body.answer
    ) {
        res.status(403);
        res.send(`required parameters missing, 
        example request body:
        {
            question: "can I use this dashboard without permission of inzamam malik",
            answer: "no you can not"
           
        } `);
        return;
    }

    const queryResponse = await index.query({
        queryRequest: {
            id: req.params.faqId,
            topK: 1,
            includeValues: true,
            includeMetadata: true,
            namespace: process.env.PINECONE_NAME_SPACE
        }
    });

    if (queryResponse.matches.length === 0) {
        res.send("no record found with id " + req.params.faqId)
        return;
    }
    console.log(`${queryResponse.matches.length} record found for edit`);


    const response = await openai.createEmbedding({
        model: "text-embedding-ada-002",
        input: `${req.body.question} - ${req.body.answer}`,
    });
    const vector = response?.data?.data[0]?.embedding
    console.log("vector: ", vector);

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);
    const upsertRequest = {
        vectors: [
            {
                id: req.params.faqId, // unique id,
                values: vector,
                metadata: {
                    question: req.body.question,
                    answer: req.body.answer,
                    created: Date.now(),
                    modified: Date.now()
                },
            }
        ],
        namespace: process.env.PINECONE_NAME_SPACE,
    };
    const upsertResponse = await index.upsert({ upsertRequest });

    res.send('faq updated');
})

router.delete('/faq/:faqId', async (req, res, next) => {

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);

    const queryResponse = await index.query({
        queryRequest: {
            id: req.params.faqId,
            topK: 1,
            includeValues: true,
            includeMetadata: true,
            namespace: process.env.PINECONE_NAME_SPACE
        }
    });

    if (queryResponse.matches.length === 0) {
        res.send("no record found with id " + req.params.faqId)
        return;
    }
    console.log(`${queryResponse.matches.length} record found for delete`);

    const deleteResponse = await index.delete1({
        ids: [req.params.faqId], // ["id123", "id456", "id789"]
        namespace: process.env.PINECONE_NAME_SPACE
    })

    console.log("deleteResponse: ", deleteResponse);
    res.send(' deleted ');
})
router.delete('/faqs', async (req, res, next) => {

    if (!req?.body?.id || !req?.body?.id?.length === 0) {
        res.status(403).send(`required parameter missing, 
        please provide id array in body with one or more ids. 
        example request body:
        {
            id: ["id1", "id2", ... , "idn"],
        }
        `)
        return;
    }

    const index = pinecone.Index(process.env.PINECONE_INDEX_NAME);
    const deleteResponse = await index.delete1({
        // deleteAll: true,
        ids: req?.body?.id,
        namespace: process.env.PINECONE_NAME_SPACE
    })
    console.log("deleteResponse: ", deleteResponse);

    res.send('all faqs deleted ');
})


export default router